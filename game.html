<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Telegraph Runner ‚Äî Arcade v3 (Fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#041424; --accent:#22d3ee; --accent-2:#67e8f9; --muted:#9fb0c1; --good:#34d399; --bad:#f87171;
    --color-background: #0F172A; --color-text-light: #E2E8F0; --color-text-dark: #94A3B8; --color-card-dark: rgba(30, 41, 59, 0.5);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#03161a,#041424);font-family:Inter, Arial, sans-serif;color:#e6f6fb; display: flex;}
  
  .sidebar { width: 240px; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border-right: 1px solid rgba(148, 163, 184, 0.2); padding: 20px; height: 100vh; position: fixed; left: 0; top: 0; transition: transform 0.3s ease-in-out; }
  .sidebar h2 { color: white; font-size: 1.2rem; margin: 0 0 20px 0; text-align: center; font-family: 'Inter', sans-serif; }
  .sidebar nav { display: flex; flex-direction: column; }
  .sidebar nav a { color: var(--color-text-dark); text-decoration: none; padding: 12px 15px; margin-bottom: 8px; border-radius: 5px; font-weight: 600; transition: color 0.2s, background-color 0.2s; }
  .sidebar nav a:hover { color: white; background-color: var(--color-card-dark); }
  .sidebar nav a.active { color: var(--accent); background-color: rgba(34, 211, 238, 0.1); }
  
  .main-content { margin-left: 240px; width: calc(100% - 240px); transition: margin-left 0.3s ease-in-out; }
  
  body.sidebar-hidden .sidebar { transform: translateX(-100%); }
  body.sidebar-hidden .main-content { margin-left: 0; width: 100%; }

  .wrap{max-width:1100px;margin:18px auto;padding:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px 10px}
  h1{font-family:'Press Start 2P',monospace;font-size:18px;margin:0;color:var(--accent)}
  .hud{display:flex;gap:10px;align-items:center;font-weight:700}
  .hud .pill{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
  #gameCanvas{display:block;margin:10px auto;border-radius:8px; background: linear-gradient(180deg,#082b34,#041424); box-shadow:0 14px 40px rgba(0,0,0,0.6); max-width:100%;}
  .controls{max-width:1100px;margin:10px auto;color:var(--muted);font-size:0.95rem}
  .buttons{display:flex;gap:8px;margin-top:8px}
  button,a.button{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041426;border:0;padding:8px 10px;border-radius:8px;font-weight:700;text-decoration:none;cursor:pointer}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(2px);z-index:90;display:none}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#072f36;border:1px solid rgba(255,255,255,0.06);padding:18px;border-radius:10px;color:#e6f6fb;min-width:320px;z-index:100;display:none}
  .timing-bar { width: 100%; height: 26px; background: rgba(255,255,255,0.04); border-radius:6px; position:relative; overflow:hidden; border:1px solid rgba(255,255,255,0.03)}
  .timing-zone { position:absolute; top:0; height:100%; background: linear-gradient(90deg, rgba(34,211,238,0.18), rgba(103,232,249,0.12)); border-right:1px solid rgba(255,255,255,0.02); border-left:1px solid rgba(255,255,255,0.02)}
  .timing-marker { position:absolute; top:0; width:8px; height:100%; background: linear-gradient(180deg, #ffffff, #c7ffff); box-shadow:0 0 10px rgba(34,211,238,0.8); transform:translateX(-50%); }
  .progress-dots { display:flex; gap:6px; margin-top:10px; justify-content:center }
  .dot { width:14px; height:14px; border-radius:50%; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.03) }
  .dot.on { background:var(--good); box-shadow:0 0 10px rgba(52,211,153,0.5) }
  .big-cta { font-size:1rem; padding:10px 14px; border-radius:10px; font-weight:800; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#041426; border:0; cursor:pointer }
  .small-btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(0,0,0,0.06); color:var(--muted); cursor:pointer }
  .small{font-size:0.92rem;color:var(--muted)}
  footer{max-width:1100px;margin:18px auto;color:var(--muted);font-size:0.9rem;text-align:center}
  .leaderboard-scores { list-style: none; padding: 0; margin-top: 12px; }
  .leaderboard-scores li { display: flex; justify-content: space-between; padding: 4px 8px; border-radius: 4px; }
  .leaderboard-scores li:nth-child(odd) { background-color: rgba(255,255,255,0.03); }
  .leaderboard-scores .rank { font-weight: bold; color: var(--accent-2); }
  .leaderboard-scores .name { font-weight: 600; }
  .leaderboard-scores .score { font-family: 'Press Start 2P', monospace; font-size: 0.9rem; color: var(--good); }
</style>
</head>
<body>

<aside class="sidebar">
    <h2>The Story of Information</h2>
    <nav>
        <a href="index.html">Introduction</a>
        <a href="chapter3.html">Timeline & Quiz</a>
        <a href="machines.html">Machines</a>
        <a href="mind.html">The Mind</a>
        <a href="game.html" class="active">Game</a>
        <a href="conclusion.html">Conclusion</a>
        <a href="process.html">Our Process</a>
    </nav>
    <div style="margin-top: 20px; text-align: center;">
        <button id="toggleSidebarBtn" class="small-btn">Toggle Menu</button>
    </div>
</aside>

<div class="main-content">
  <div class="wrap">
    <header>
      <h1>Telegraph Runner</h1>
      <div class="hud">
        <div class="pill">Level: <span id="hud-level">1</span></div>
        <div class="pill">Score: <span id="hud-score">0</span></div>
        <div class="pill">Lives: <span id="hud-lives">3</span></div>
        <div class="pill">Stations: <span id="hud-stations">0/0</span></div>
        <div class="pill">‚è± Time: <span id="hud-timer">45</span>s</div>
      </div>
    </header>

    <canvas id="gameCanvas" width="1000" height="560" aria-label="Telegraph Runner Arcade Game"></canvas>

    <div class="controls">
      <div class="small">Controls: ‚Üê ‚Üí to move, ‚Üë or Space to jump. Press <strong>F</strong> or <strong>Shift</strong> to shoot. Reach telegraph stations and play the timing mini-game to connect them. Each station repaired shrinks the timing zone for the next one.</div>
      <div class="buttons">
        <button id="startBtn">Start / Restart</button>
        <button id="muteBtn">üîä Toggle Sound</button>
        <button id="leaderboardBtn">üèÜ Leaderboard</button>
      </div>
    </div>

    <footer>
      <div>Made for COM216 ‚Äî ¬© 2025 Hayden Klahs</div>
      <div id="highscoreText" style="margin-top:6px">High Score: 0</div>
    </footer>
  </div>
</div>

  <div id="overlay" class="overlay"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true"></div>

<script>
// --- CONFIGURATION ---
const CONFIG = {
    gravity: 1200, moveSpeed: 220, jumpSpeed: 460, canvasWidth: 1000, canvasHeight: 560,
    initialLives: 3, levelStartTime: 45, timingHitsNeeded: 3, timingSpeed: 1.6,
    timingZoneOriginal: 0.20, timingShrinkFactor: 0.9, timingZoneMin: 0.08,
    dronesPerLevel: 4, pulseLimit: 3, droneHitPenaltySeconds: 5,
    droneScore: 100, scoring: { baseConnect: 150, timeBonus: 4, perfectBonus: 200 },
    timeGainOnComplete: 10, timePenaltyOnMiss: 7
};

// --- DOM ELEMENTS ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const hud = {
    level: document.getElementById('hud-level'),
    score: document.getElementById('hud-score'),
    lives: document.getElementById('hud-lives'),
    stations: document.getElementById('hud-stations'),
    timer: document.getElementById('hud-timer'),
    highscore: document.getElementById('highscoreText')
};
const overlay = document.getElementById('overlay');
const modal = document.getElementById('modal');

// --- GAME STATE ---
let keys = {};
let lastTime = 0;
let player, platforms, stations, particles, pulses, drones;
let score, lives, currentLevel, levelTime, levelTimer, levelStationsTotal, connectedCount;
let running = false;
let audioCtx = null;
let audioEnabled = true;
const storageKey = 'telegraph_runner_leaderboard';
let timingZoneRatio = CONFIG.timingZoneOriginal;
let respawnImmunity = 0;

// --- LEVELS ---
const LEVELS = [
    { platforms: [{x:0,y:520,w:1000,h:40},{x:120,y:440,w:160,h:18},{x:360,y:380,w:160,h:18},{x:640,y:320,w:200,h:18},{x:860,y:240,w:120,h:18}], stations: [{x:140,y:420},{x:380,y:340},{x:900,y:200}] },
    { platforms: [{x:0,y:520,w:1000,h:40},{x:60,y:440,w:120,h:18},{x:220,y:380,w:140,h:18},{x:420,y:320,w:140,h:18},{x:620,y:260,w:120,h:18},{x:820,y:200,w:140,h:18}], stations: [{x:80,y:420},{x:460,y:300},{x:840,y:180}] },
    { platforms: [{x:0,y:520,w:1000,h:40},{x:60,y:460,w:110,h:18},{x:200,y:420,w:160,h:18},{x:420,y:360,w:180,h:18},{x:640,y:300,w:160,h:18},{x:820,y:240,w:140,h:18}], stations: [{x:220,y:400},{x:460,y:340},{x:700,y:260},{x:860,y:220}] }
];

// --- CORE GAME LOGIC ---
function init() {
    canvas.width = CONFIG.canvasWidth;
    canvas.height = CONFIG.canvasHeight;
    setupLevel(1, true);
    render();
}

function startGame(level) {
    const isNewGame = level === 1;
    setupLevel(level, isNewGame);
    hideModal();
    running = true;
    lastTime = performance.now();
    startLevelTimer();
    requestAnimationFrame(loop);
}

function loop(timestamp) {
    if (!running) return;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;
    
    update(dt);
    render();
    
    requestAnimationFrame(loop);
}

function update(dt) {
    if (respawnImmunity > 0) respawnImmunity -= dt;
    playerUpdate(dt);
    updateDrones(dt);
    updatePulses(dt);
    checkStationCollision();
}

function render() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const g=ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,'#082b34'); g.addColorStop(1,'#041424');
    ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  
    platforms.forEach(p => { ctx.fillStyle='#153842'; roundRect(ctx,p.x,p.y,p.w,p.h,6,true,false); });
    stations.forEach(s => {
        ctx.fillStyle=s.connected?'#20382a':'#2a2e3a'; roundRect(ctx,s.x-18,s.y-20,68,40,8,true,false);
        ctx.fillStyle=s.connected?'#34d399':'#67e8f9'; ctx.fillRect(s.x+8,s.y-42,6,26);
        ctx.beginPath(); ctx.arc(s.x+20,s.y-6,8,0,Math.PI*2);
        ctx.fillStyle=s.connected?'rgba(52,211,153,0.95)':'rgba(34,211,238,0.95)'; ctx.fill();
        ctx.fillStyle='#041526'; ctx.font='700 12px Inter, Arial'; ctx.textAlign='center'; ctx.fillText(s.connected?'‚úì':'?',s.x+20,s.y-2);
    });
    drones.forEach(d => { if(d.alive) { ctx.fillStyle='#ffce54'; ctx.fillRect(d.x-8,d.y-8,16,16); }});
    pulses.forEach(p => { ctx.fillStyle = 'rgba(160,240,255,0.98)'; ctx.fillRect(p.x-4, p.y-3, 8, 6); });
    
    if (respawnImmunity <= 0 || (Math.floor(Date.now() / 100) % 2 === 0)) {
      ctx.fillStyle='#f6f9fb'; roundRect(ctx, player.x, player.y, player.w, player.h, 6, true, false);
    }
    
    particles.forEach(p => { p.vy+=800*0.016; p.x+=p.vx*0.016; p.y+=p.vy*0.016; p.life-=0.016; ctx.fillStyle=`rgba(34,211,238,${Math.max(0,p.life/1)})`; ctx.fillRect(p.x,p.y,3,3); });
    particles = particles.filter(p => p.life > 0);
}

// --- ENTITY & STATE MANAGEMENT ---
function setupLevel(n, isNewGame) {
    const L = LEVELS[(n - 1) % LEVELS.length];
    platforms = L.platforms.map(p => ({...p}));
    stations = L.stations.map(s => ({...s, connected: false}));
    levelStationsTotal = stations.length;
    connectedCount = 0;
    player = { x: 80, y: 400, vx: 0, vy: 0, w: 24, h: 36, onGround: false, facing: 1 };
    
    if (isNewGame) {
        score = 0;
        lives = CONFIG.initialLives;
        timingZoneRatio = CONFIG.timingZoneOriginal;
    }

    levelTime = CONFIG.levelStartTime;
    currentLevel = n;
    
    updateHUD();
    spawnDrones();
    hud.highscore.textContent = `High Score: ${localStorage.getItem(storageKey) || 0}`;
}

function playerUpdate(dt) {
    if (!player) return;
    
    const acc = CONFIG.moveSpeed;
    if(keys['ArrowLeft'] || keys['a']){ player.vx = -acc; player.facing = -1; }
    else if(keys['ArrowRight'] || keys['d']){ player.vx = acc; player.facing = 1; }
    else { player.vx = 0; }

    if((keys['ArrowUp'] || keys['w'] || keys[' ']) && player.onGround){
        player.vy = -CONFIG.jumpSpeed; player.onGround = false;
    }

    if (!player.onGround) player.vy += CONFIG.gravity * dt;
    
    player.x += player.vx * dt;
    player.y += player.vy * dt;

    player.onGround = false;
    for(const p of platforms){
        if(rectsOverlap(player, p)){
            const prevBottom = (player.y + player.h) - (player.vy * dt);
            if(prevBottom <= p.y){
                player.y = p.y - player.h; player.vy = 0; player.onGround = true;
            }
        }
    }
    if(player.y > CONFIG.canvasHeight + 100) loseLife();
}

function updateDrones(dt){
  drones.forEach(d => {
    if(!d.alive) return;
    d.wobble += dt * 4;
    d.x = d.baseX + Math.sin(d.wobble) * (d.range / 2);
    d.y += Math.sin(d.wobble*0.6) * 0.2;

    for(let i = pulses.length - 1; i >= 0; i--){
        const p = pulses[i];
        if(p.active && rectsOverlap({x:d.x-8, y:d.y-8, w:16, h:16}, {x:p.x-4, y:p.y-3, w:8, h:6})){
            d.alive = false;
            p.active = false;
            onDroneDestroyed(d);
        }
    }

    if(d.alive && rectsOverlap(player, {x:d.x-8,y:d.y-8,w:16,h:16}) && respawnImmunity <= 0){
      d.alive = false;
      onDroneCollision();
    }
  });
}

function updatePulses(dt){
  for(let i=pulses.length-1; i>=0; i--){
    const p = pulses[i];
    if(!p.active) { pulses.splice(i,1); continue; }
    p.x += p.dir * p.speed * dt;
    p.life -= dt;
    if(p.life <= 0 || p.x < -20 || p.x > canvas.width + 20) p.active = false;
  }
}

function checkStationCollision(){
  stations.forEach((s, idx) => {
    if (!s.connected && rectsOverlap(player, {x:s.x-18, y:s.y-20, w:68, h:40})) {
      openStationRepair(idx);
    }
  });
}

function onDroneCollision() {
    loseLife();
    playStatic();
    levelTime = Math.max(0, levelTime - CONFIG.droneHitPenaltySeconds);
}

function updateHUD() {
    hud.level.textContent = currentLevel;
    hud.score.textContent = score;
    hud.lives.textContent = lives;
    hud.stations.textContent = `${connectedCount}/${levelStationsTotal}`;
    hud.timer.textContent = Math.max(0, Math.floor(levelTime));
}

function loseLife(){
  if (respawnImmunity > 0) return; 
  lives--;
  respawnImmunity = 2.5;
  spawnParticles(player.x+player.w/2, player.y+player.h/2, 18);
  
  if(lives <= 0){
    gameOver();
  } else {
    player.x = 80;
    player.y = 400;
    player.vy = 0;
  }
  updateHUD();
}

function gameOver(){
  running = false;
  clearInterval(levelTimer);
  const prevHigh = parseInt(localStorage.getItem(storageKey) || '0', 10);
  if (score > prevHigh) {
    localStorage.setItem(storageKey, String(score));
    hud.highscore.textContent = `High Score: ${score}`;
  }
  showModal(`<h3>Game Over</h3><p class="small">You ran out of lives.</p><div style="margin-top:10px"><button onclick="hideModal(); startGame(1);" class="big-cta">Restart</button></div>`);
}

function checkWin(){
  if(connectedCount >= levelStationsTotal){
    running = false;
    clearInterval(levelTimer);
    score += 500 + Math.floor(levelTime * CONFIG.scoring.timeBonus);
    updateHUD();
    showModal(`<h3>Level ${currentLevel} Complete!</h3><p class="small">Score: ${score}</p><div style="margin-top:10px"><button onclick="hideModal(); startGame(currentLevel + 1);" class="big-cta">Next Level</button></div>`);
  }
}

function showModal(html){ overlay.style.display='block'; modal.style.display='block'; modal.innerHTML = html; }
function hideModal(){ overlay.style.display='none'; modal.style.display='none'; }

function getLeaderboard() {
  try {
    const data = localStorage.getItem(storageKey);
    return data ? JSON.parse(data) : [];
  } catch (e) { return []; }
}

function saveLeaderboard(board) {
  try {
    localStorage.setItem(storageKey, JSON.stringify(board));
  } catch (e) { console.error("Could not save leaderboard", e); }
}

function checkLeaderboard() {
    running = false;
    const board = getLeaderboard();
    const lowestScore = board.length < 5 ? 0 : board[board.length - 1].score;

    if (score > lowestScore) {
        const name = prompt("New High Score! Enter your name (3 characters):", "AAA");
        if (name) {
            const newEntry = { name: name.substring(0, 3).toUpperCase(), score: score };
            board.push(newEntry);
            board.sort((a, b) => b.score - a.score);
            if (board.length > 5) board.pop();
            saveLeaderboard(board);
        }
    }
    showLeaderboard(true);
}

function showLeaderboard(fromGameOver = false) {
  running = false;
  clearInterval(levelTimer);
  const board = getLeaderboard();
  let html = `
    <h2 style='margin-top:0'>Leaderboard</h2>
    <ol class='leaderboard-scores'>
      ${board.map((s, i) => `<li><div><span class='rank'>#${i+1}</span> <span class='name'>${s.name}</span></div><div class='score'>${s.score}</div></li>`).join('')}
      ${board.length === 0 ? "<li>No scores yet!</li>" : ""}
    </ol>
    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center;">
        <button class='big-cta' onclick='hideModal(); startGame(1);'>New Game</button>
        ${!fromGameOver ? "<button class='small-btn' onclick='hideModal(); resumeGame();'>Resume</button>" : ""}
    </div>
  `;
  showModal(html);
}

function onStationConnected(stationIdx) {
    stations[stationIdx].connected = true;
    connectedCount++;
    score += CONFIG.scoring.baseConnect + Math.floor(levelTime * CONFIG.scoring.timeBonus);
    levelTime += CONFIG.timeGainOnComplete;
    
    updateHUD();
    hideModal();

    if (connectedCount === levelStationsTotal) {
      running = false;
      showModal(`<h3>Level ${currentLevel} Complete!</h3><p class="small">Score: ${score}</p><div style="margin-top:10px"><button onclick="hideModal(); startGame(currentLevel + 1);" class="big-cta">Next Level</button></div>`);
    } else {
      resumeGame();
    }
}

function showTimingMiniGame(stationIdx){
  running = false;
  clearInterval(levelTimer);
  let timingActive = true;
  let timingMarkerPos = 0;
  let timingMarkerSpeed = CONFIG.timingSpeed;
  let timingHits = 0;
  let lastTimingFrame = performance.now();

  const currentZoneRatio = CONFIG.timingZoneOriginal * Math.pow(CONFIG.timingShrinkFactor, connectedCount);
  const zoneStart = (1 - currentZoneRatio) / 2;
  const zoneEnd = zoneStart + currentZoneRatio;

  modal.innerHTML = `
    <h2 style='margin-top:0'>Connect Station</h2>
    <p class='small'>Press [Space] or click REPAIR inside the zone!</p>
    <div class='timing-bar'>
      <div class='timing-zone' style='left:${zoneStart*100}%; width:${currentZoneRatio*100}%'></div>
      <div class='timing-marker' id='timing-marker'></div>
    </div>
    <div class='progress-dots' id='progress-dots'>
      ${Array(CONFIG.timingHitsNeeded).fill("<div class='dot'></div>").join('')}
    </div>
    <div style="margin-top: 16px;"><button class='big-cta' id="repairBtn">REPAIR</button></div>
  `;
  showModal('', modal.innerHTML);
  
  const markerElem = document.getElementById('timing-marker');
  const dots = document.getElementById('progress-dots').children;

  function timingLoop(now) {
    if (!timingActive) return;
    const dt = (now - lastTimingFrame) / 1000;
    lastTimingFrame = now;
    timingMarkerPos += timingMarkerSpeed * dt;
    if (timingMarkerPos > 1 || timingMarkerPos < 0) {
      timingMarkerSpeed *= -1;
      timingMarkerPos = Math.max(0, Math.min(1, timingMarkerPos));
    }
    markerElem.style.left = `${timingMarkerPos * 100}%`;
    requestAnimationFrame(timingLoop);
  }

  function handleTimingAction() {
    if (timingMarkerPos >= zoneStart && timingMarkerPos <= zoneEnd) {
      timingHits++;
      dots[timingHits - 1].classList.add('on');
      playBeep(0.05, 1400);
      if (timingHits >= CONFIG.timingHitsNeeded) {
        timingActive = false;
        window.removeEventListener('keydown', handleTimingKeyPress);
        onStationConnected(stationIdx);
      }
    } else {
      playBeep(0.08, 440);
      levelTime = Math.max(0, levelTime - CONFIG.timePenaltyOnMiss);
      updateHUD();
    }
  }
  
  document.getElementById('modal').querySelector('.big-cta').onclick = handleTimingAction;
  const handleTimingKeyPress = (e) => {
    if (e.key === ' ' || e.key === 'Spacebar') {
        e.preventDefault();
        handleTimingAction();
    }
  };
  window.addEventListener('keydown', handleTimingKeyPress);
  requestAnimationFrame(timingLoop);
}

function resumeGame(){
  if(modal.style.display === 'none'){
    running = true;
    startLevelTimer();
    lastTime = performance.now();
    requestAnimationFrame(loop);
  }
}

function roundRect(ctx,x,y,w,h,r,fill,stroke){ ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();if(fill)ctx.fill();if(stroke)ctx.stroke();}
function ensureAudio(){ if(!audioEnabled) return null; if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
function playBeep(duration, freq=880){ if(!audioEnabled) return; const ctx=ensureAudio(); const osc=ctx.createOscillator(),gain=ctx.createGain();osc.type='square';osc.frequency.value=freq;gain.gain.value=0.0001;osc.connect(gain);gain.connect(ctx.destination);const t0=ctx.currentTime;gain.gain.exponentialRampToValueAtTime(0.1,t0+0.002);osc.start(t0);gain.gain.exponentialRampToValueAtTime(0.0001,t0+duration);osc.stop(t0+duration+0.01); }
function playStatic(){ if(!audioEnabled) return; const ctx=ensureAudio();const bufferSize=2*ctx.sampleRate,buffer=ctx.createBuffer(1,bufferSize,ctx.sampleRate),data=buffer.getChannelData(0);for(let i=0;i<bufferSize;i++)data[i]=(Math.random()*2-1)*0.5;const source=ctx.createBufferSource();source.buffer=buffer;const gain=ctx.createGain();gain.gain.value=0.12;source.connect(gain);gain.connect(ctx.destination);source.start();setTimeout(()=>{try{source.stop();}catch(e){}},160);}
function playStaticPop(){ if(!audioEnabled) return; const ctx=ensureAudio();const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=1200;g.gain.value=0.0001;o.connect(g);g.connect(ctx.destination);const t0=ctx.currentTime;g.gain.exponentialRampToValueAtTime(0.12,t0+0.002);o.start(t0);g.gain.exponentialRampToValueAtTime(0.0001,t0+0.06);o.stop(t0+0.07);}

// --- EVENT LISTENERS ---
window.addEventListener('keydown',(e)=>{ keys[e.key]=true; if(["ArrowUp"," ","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault(); if((e.key==='f' || e.key==='F' || e.key==='Shift') && running) shootPulse(); });
window.addEventListener('keyup',(e)=>{ keys[e.key]=false; });
document.getElementById('muteBtn').onclick = () => { audioEnabled=!audioEnabled; document.getElementById('muteBtn').textContent = audioEnabled ? 'üîä Toggle Sound' : 'üîà Sound Off'; };
document.addEventListener('visibilitychange',()=>{ if(document.hidden && running) { running=false; clearInterval(levelTimer); } });
document.getElementById('toggleSidebarBtn').onclick = () => document.body.classList.toggle('sidebar-hidden');

// --- INITIALIZE ---
init();
</script>
</body>
</html>
